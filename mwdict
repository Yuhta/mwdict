#!/usr/bin/env node
"use strict";

var fs          = require('fs'),
    nreplClient = require('nrepl-client'),
    os          = require('os'),
    path        = require('path'),
    Promise     = require('bluebird'),
    util        = require('util');

if (process.argv.length != 3) {
    console.error("Usage: %s WORD-TO-SEARCH", process.argv[1]);
    process.exit(1);
}
var word = process.argv[2];
var nreplPortFile = path.join(os.homedir(), '.clj-center-nrepl-port');
var port = fs.readFileSync(nreplPortFile, 'utf8');
var conn = Promise.promisifyAll(nreplClient.connect({port: port}));
conn.onceAsync('connect').then(function () {
    var code = util.format('(-main %s)', JSON.stringify(word));
    return conn.evalAsync(code, 'mwdict.core');
}).then(function (results) {
    results.forEach(function (result) {
        if (result.out) process.stdout.write(result.out);
        if (result.err) {
            process.stderr.write(result.err);
            process.exitCode = 1;
        }
    });
}).finally(function () {
    conn.end();
});
